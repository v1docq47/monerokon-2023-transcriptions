# Пиюш Шарма

_**Уровень анонимности одноранговой сети, обеспечиваемый схемами, используемыми криптовалютами**_

[https://youtu.be/si4oCQAUFsY](https://youtu.be/si4oCQAUFsY)

---

_**Пиюш:**_ Это выступление будет посвящено уровню анонимности одноранговой сети, лежащей в основе всех криптовалютных систем.

Как уже было сказано, меня зовут Пиюш Кумар Шарма, и данная работа является результатом сотрудничества с Девашишем и Клаудией из KU Leuven, Института Макса Планка и NYM. Кроме того, эта работа уже была представлена на симпозиуме NDSS, который является академической конференцией, и это адаптированная для данного мероприятия версия.

Итак, без лишних слов, я кратко расскажу о предпосылках изучения этой проблемы. Когда речь заходит о криптовалютных системах, мы можем представить их в очень широком смысле как системы, функционирующие на двух уровнях. Один из них– прикладной уровень, который отвечающий в основном за создание транзакций, вычисление блоков, проверку и прочие подобные вещи.

Но ниже находится сетевой уровень, на котором вся эта информация распространяется по сети среди одноранговых узлов. То есть, по сути, это одноранговая сеть подключенных узлов, где любая транзакция, любой блок, который вы генерируете, транслируется в сеть.

И если говорить об анонимности, нам бы хотелось, чтобы она обеспечивалась  на обоих уровнях. Существует множество методов, делающих это  на прикладном уровне, но анонимность также должна присутствовать и на сетевом уровне. Ведь если он обеспечивается только на прикладном уровне, отсутствуя при этом на сетевом, то такая анонимность не является полной.

Когда я говорю об анонимности на сетевом уровне, то, по сути, имею в виду возможность сопоставления сетевой учётной записи, идентификационных данных пользователя с транзакциями, проводимыми в сети. Такими идентификационными данными могут являться IP-адреса.

Учитывая вышесказанное, мы можем вкратце рассмотреть одну из самых популярных криптовалютных систем - Bitcoin. В этой одноранговой сети при проведении транзакции она по умолчанию рассылается всем соседним узлам. Так было до 2015 года - транзакция транслировалась всем соседним узлам и так далее.

Впоследствии метод был обновлён, и теперь вместо того, чтобы сразу передавать транзакцию всем узлам, она стала передаваться по одному узлу за раз, но с некоторой задержкой. Однако, как выяснилось, оба эти подхода были уязвимы к атакам с целью деанонимизации. Один - раньше, другой - позже. Поэтому в последнее время в исследовательских работах предлагаются новые подходы к повышению анонимности криптовалютных систем на сетевом уровне.

Такие подходы можно разделить на схемы пошаговой маршрутизации и схемы исходной маршрутизации. Разница состоит в том, что при использовании схем пошаговой маршрутизации решение о маршруте транзакции или пакета принимается при совершении каждого шага. В каждом случае, кому из соседних узлов будет передана транзакция, решается случайным образом. В случае исходной маршрутизации весь маршрут транзакции является фиксированным, и отправитель сам решает, какие промежуточные шаги будут совершены вплоть до адресата.

И в обеих этих категориях схем есть свои системы. Одна из них - Dandelion и Dandelion++, являющаяся частью схемы пошаговой маршрутизации. Эта система также используется Monero для обеспечения анонимности на сетевом уровне, и поэтому это выступление должно заинтересовать сообщество. Но после этого я также расскажу и о схемах исходной маршрутизации, обеспечивающих совершенно иной вид маршрутизации. Ведь нас прежде всего интересует анализ анонимности.

Итак, до этого момента мы знали, что существуют разные виды схем маршрутизации, обладающие различными свойствами маршрутизации и анонимности. Но фундаментальная проблема заключается в том, что мы не знаем, как понять, какой уровень анонимности они обеспечивают, именно потому, что они разные, и мы не знаем, как сравнить их на общей основе.

Поэтому одной из основных задач исследования стало приведение всех схем к общей основе и определение того, как проанализировать анонимность любой отдельно взятой одноранговой системы. В данном случае модель со стороны злоумышленника предполагает наличие в сети нескольких вредоносных узлов, и злоумышленник пытается на сетевом уровне каким-то образом узнать, кто является инициатором транзакций, получаемых этими узлами.

Вот, чего и как мы хотим добиться. На верхнем уровне мы хотим создать структуру, которая в качестве исходных данных будет использовать структуру сети, которая сможет определить, какова связность в сети? Мы хотим определить, какова будет схема маршрутизации при отправке сообщений или транзакций в сети, и что можно выявить, наблюдая за сетью, что можно узнать о транзакциях, блоках и так далее.

Как только мы введём все эти данные в свою структуру, она покажет, каков уровень анонимности в сети, или сколько пользователей или сколько отправителей я могу деанонимизировать, или же, если я не могу их деанонимизировать, какова вероятность угадать это в случае с каждой конкретной транзакцией. И мы можем сделать всё это с помощью понятия байесовской вероятности. И здесь я перехожу к тому, как строится наша структура с учётом этой идеи.

Итак, чтобы определить эту структуру, нам необходимо определить несколько составляющих. Это очень простые составляющие. Первая из них - Bi. По сути, это некий доброкачественный узел или нормальный узел, принимающий и отправляющий транзакции в обычном режиме. Вторая составляющая - красный узел, контролируемый злоумышленником и принимающий транзакции. Учитывая эти две составляющие, что нам интересно узнать с точки зрения анонимности?

Это вероятность, являющаяся условной вероятностью, P(Bi|A). И это означает, что если некий узел злоумышленника получил транзакцию, в нашем случае это красный узел, то какова будет вероятность того, что некий узел i сгенерировал её в сети? Если мы сможем получить эти данные для всех возможных отправителей в сети, то сможем понять, кто является наиболее вероятным отправителем, кто наименее вероятным, и затем использовать эту информацию для вычисления уровня анонимности.

Но как вычислить вероятность P(Bi|A)? Для этого в теореме Байеса имеется такая вот формула. Данную вероятность можно вычислить, рассчитав эти члены, что они, по сути, означают в данном контексте. P(Bi) - это вероятность, с которой некоторый доброкачественный узел i генерирует транзакцию. P(A) - вероятность получения какой-либо транзакции узлом злоумышленника. Ну а P(A|Bi) - это вероятность того, что, учитывая, что некоторый доброкачественный узел i сгенерировал транзакцию, вероятность того, что эта транзакция достигнет узла злоумышленника. Таким образом, это немного отличается от предыдущей вероятности. И при наличии всех этих значений, мы можем вычислить A для всех i и таким образом разобраться в ситуации. Так как же нам это сделать?

Предположим, что в сети есть N узлов, есть C вредоносных узлов. И тогда P(Bi), то есть вероятность того, что узел сгенерирует транзакцию, считается равной для всех. То есть каждый узел в сети с одинаковой вероятностью может сгенерировать транзакцию.

Теперь, с точки зрения вмешательства злоумышленника, это довольно плохой сценарий, поскольку мы не знаем, насколько велика вероятность того, что кто-то сгенерирует транзакцию. Но всё же мы видим, что даже при таких условиях уровень анонимность не очень высок.

Таким образом мы можем рассчитать вероятность того, что узел сгенерирует транзакцию. Вероятность того, что какая-либо транзакция дойдёт до злоумышленника, можно вычислить, умножив вероятность того, что узел сгенерирует транзакцию, на вероятность того, что транзакция достигнет злоумышленника. И если сделать это для всех узлов в сети, то так можно получить соответствующий результат. И, не вдаваясь в дальнейшие подробности, если мы подставим эти значения в формулы, то в итоге получим то, что находится в крайнем правом углу. И в этом случае единственное, что нам нужно будет вычислить - P(A|Bi), некоторую вероятность, и мы рассмотрим, как это можно сделать. И как только мы получим результат, мы узнаем распределение вероятностей возможных отправителей для любой конкретной транзакции.

И всё это хорошо. Но что нам делать с этой информацией? Эти распределения вероятностей ничего не говорят нам о том, кто является вероятным отправителем или сколько возможных отправителей существует для этих транзакций.

Для этого, для вычисления уровня анонимности, мы используем нечто, известное как энтропия, которая задаётся этой формулой. По сути, она означает следующее - да, она измеряется в битах - если энтропия составляет два бита, это означает выбор между двумя в степени двух возможными  центрами. А если энтропия составляет ноль бит, это означает, что вы можете чётко деанонимизировать, то есть, вы точно будете знать, кто является потенциальным отправителем, верно, потому что это значение составит 2 в степени 0.

Итак, в этом случае у нас есть распределения вероятностей, и мы можем рассчитать уровень анонимности. Теперь о том, как использовать эту структуру для моделирования существующих схем пошаговой и исходной маршрутизации.

Начнём со схемы пошаговой маршрутизации. Начнём с протокола Dandelion. Как работает эта схема? По сути, она использует два набора графов. Что представляет собой первый граф? Прежде всего, это существующий одноранговый граф Bitcoin, который есть в сети. Во-вторых, он создает свой собственный подграф приватности, который является подграфом фактического графа Bitcoin. Почему это подграф? Потому что он охватывает все узлы в сети, но предполагается, что это линейный граф. Далее мы увидим, почему это важно и как это обеспечивает анонимность, но, по сути, именно так работает Dandelion - с помощью этих двух графов.

Помимо наличия этих двух графов, протокол предусматривает наличие двух фаз: фазы «ствола» и фазы «пуха». Рассмотрим, что происходит на этих фазах.

Итак, предположим, что это сеть, в которой изначально каждая транзакция находится в фазе ствола. То есть она будет направлена в подграф приватности. Допустим, у узла Bi есть транзакция, которую он хочет передать в сеть. Вместо того, чтобы сразу транслировать её в сеть, узел в определённый момент сначала передаст её некоторым узлам-посредникам, присутствующим в сети. После этого каждый узел примет решение, продолжать ли пересылать транзакцию по одной линии или же транслировать её в сеть. И в какой-то момент, в данном случае, когда транзакция достигнет узла Bj, она будет передана в сеть, которая здесь находится справа. Ранее или в предшествующих работах уже говорилось о том, что данный процесс распространения, то есть так его часть, в которой узел Bj транслирует транзакцию в сеть, всё ещё позволяет определить отправителя. Так что в этом случае, соответствующий анализ позволяет узнать, что инициатором является узел Bj, правильно? Но ведь первоначальным источником был узел Bi. Таким образом, протокол Dandelion обеспечивает анонимность транзакций. И обеспечивает её, по сути, на стадии стебля. Поэтому имеет смысл рассматривать только эту фазу и то, как мы можем включить её в нашу структуру.

Как это сделать? Мы абстрагировались от этого линейного графа, который был на линии передачи, то есть, от предыдущего подграфа. И здесь снова появляется узел некоего злоумышленника. Он принимает транзакцию и начинает производить вычисления. Какие это вычисления? Посмотрим на узел, который находится сразу за ним. Какова вероятность того, что транзакция от этого узла дойдет до злоумышленника?

Она равна единице. Все транзакции, сгенерированные предыдущим узлом, достигнут следующего, потому что это параметр, определяемый системой. Транзакция должна пройти, по крайней мере, один шаг. Итак, здесь все транзакции будут получены злоумышленником A, хорошо?

А что насчёт второго узла? В этом случае транзакции могут быть вычислены по одной. То есть, он передаст все свои транзакции ближайшему узлу. Но затем, начиная с этого момента, он будет решать, переслать ли транзакцию узлу A или транслировать её в сеть, основываясь на вероятности, известной как pf, которая является вероятностью передачи. В данном случае вероятность того, что транзакция достигнет узла злоумышленника A, равна 1*pf.

Подобным образом, если взять третий узел, то вероятность составит 1*pf*pf. И если обобщить это для любого доброкачественного узла в сети, то нам нужно умножить соответствующее значение (pf)hi-1 раз, где hi являетсяч количеством шагов между доброкачественным узлом i и злоумышленником.

Таким образом, мы можем смоделировать систему Dandelion. Очевидно, есть и другие способы анализа, а это просто стандартный способ. Но существуют и другие способы, с помощью которых можно сократить множество, состоящее из узлов. В данном случае возьмём, например, двух злоумышленников. Если злоумышленник, A2, получает транзакцию, то он может быть уверен, что инициатором является узел 1 или N. Отправителем не может быть узел между N+1 и M, потому что они находятся в сговоре. Если бы транзакция была сгенерирована узлами от N+1 до M, то первым её бы получил узел A1. А если бы узел A1 уже получил её, то он бы сообщил, что это произошло. Никакого анализа с их стороны не требуется. И эти небольшие изменения мы включили в наш анализ, смоделировав таким образом работу Dandelion.

Затем появилась система-преемник, Dandelion++, в которой всё осталось без изменений, но вместо линейного графа уже создавался регулярный граф четвёртой степени. По сути, это улучшение означает, что у графа имеется два исходящих ребра и два входящих ребра.

Итак, если мы берём этот граф, то как будет выглядеть подграф приватности в этом случае? В этом подграфе каждый узел будет иметь два исходящих ребра, верно? И для проведения анализа предположим, что у нас снова есть узел злоумышленника A, и нам надо вычислить, получил ли он транзакцию. Какова вероятность того, что она была получена от узла 1?

Для этого нам придётся вычислить все шаги, ведущие от узла 1 к узлу A, потому что только так транзакция могла попасть к A. В данном случае есть два пути: 1, 2, 4, A и 1, 2, 3, 4, A. И для всех этих шагов требуется вычислить вероятность, как мы делали это ранее. Итак, в данном случае узел 1 всегда будет пересылать транзакцию в один шаг, но при этом существует два вероятных шага. Поэтому он будет выбирать с равной вероятностью. Это означает, что вероятность выбора следующего узла составляет 50%. Таким образом, вероятность того, что транзакция достигнет узла 2, будет равна 1/2.

После этого, основываясь на вероятности передачи, узел принимает решение, переслать транзакцию следующему узлу или транслировать её в сеть. Если узел решит передать транзакцию дальше, то мы получим вероятность pf. И она снова будет делиться на 2, потому что он переслал её не третьему узлу, а четвёртому. И аналогично, с 4 по 8 узел вероятность составит pf/2. Мы можем рассчитать её для всех шагов. И мы можем обобщить эту схему с помощью этой формулы, где в случае с Dandelion++ мы умножим половину на (pf/2)hi-1, где hi снова будет количеством шагов. Но в данном случае нам нужно сделать это для всех возможных шагов.

Как только это будет сделано, мы снова смотрим, может ли ситуация измениться, если несколько злоумышленников будут действовать сообща? Этот пример демонстрирует, что узел A3 получит транзакцию, то он будет уверен, что возможный отправитель находится в пределах 5 до 10 узла. Это не может быть узел от 1 до 4, потому что если бы транзакция была сгенерирована каким-либо узлом от 1 до 4, она была бы перехвачена узлами A1 и A2. Более того, если внимательно посмотреть на узел 10, то если узел A3 получит транзакцию от узла 10, то он может быть на 100% уверен, что 10 является отправителем. Потому что от узла 10 до узла 1 первый же шаг ведёт к узлу злоумышленника, равно как и другой первый шаг. И если злоумышленникам известен этот граф, то они могут увидеть, что есть только один возможный путь. Ведь сами они не генерировали транзакцию. Если вы её получаете, значит, транзакция была сгенерирована вот этим узлом.

Итак, вот, как мы производим анализ Dandelion и Dandelion++. Но это только сам анализ. Каковы же результаты? Поскольку у нас не было варианта реализации для Bitcoin, нами были построены одноранговые графы, линейные графы и регулярные графы четвёртой степени. Затем мы предположили наличие случайных узлов злоумышленника в сети, в некоторой её части. Затем мы изменили различные параметры, например, влияние вероятности передачи, влияние общего количества вредоносных узлов в сети, общего количества узлов в сети и так далее.

И вот один из полученных результатов. В данном случае мы сохраняем два параметра постоянными, то есть вероятность передачи, мы сохраняем её равной 0,9. Это означает, что при совершении каждого шага есть вероятность того, что передача продолжится в фазе стебля, составляет 90%, а вероятность трансляции транзакции в сеть равна 10%. Мы также предположили, что в сети есть 1% узлов злоумышленника от общего числа узлов. В этом случае, даже при дальнейшем увеличении размера сети, видно, что по оси x, по оси y энтропия не возрастает. И это означает, что с увеличением размера сети уровень анонимности не увеличивается, что было бы логично, правильно? Когда к сети присоединяется всё больше пользователей, то возрастает и количество сомнений. Но в ходе нашего анализа выяснилось, что это не так.

Но когда мы изменяли количество вредоносных узлов в сети с 5% до 50%, мы наблюдали следующее: в случае с Dandelion, допустим, при наличии 25% сговорившихся для проведения деанонимизации узлов, то есть четвертой части сети, как можно увидеть, можно точно определить до 10% отправителей транзакций. Но средняя линия, то есть красная линия, которая приближается к двум, для 50% транзакций вызывает сомнения только в случае с четырьмя возможными отправителями. Таким образом, из 1000 транзакций в 50% случаев возникают сомнения только в четырёх.

Затем аналогичным образом мы действуем с Dandelion++. В этом случае, очевидно, общий уровень анонимности увеличился. Но если в сети будет достаточно много злоумышленников, то даже в этом случае от 10% до 5%, 10% транзакций могут быть полностью деанонимизированы.

Вот что получилось при анализе схемы пошаговой маршрутизации. Также мы можем проанализировать и схему исходной маршрутизации. В данном случае это будет Lightning Network. Что такое Lightning Network? По сути, это сеть платёжных каналов, которая была создана для обеспечения масштабируемости, а также приватности транзакций Bitcoin. В ней используется луковая маршрутизация. То есть источник решает, каким будет фактический путь, и ни один промежуточный узел не может изменить предыдущий и следующий шаг в сети.

И очевидно, поскольку транзакции проходят через различные платёжные каналы, взимается комиссия. А поскольку взимается комиссия, клиент выбирает наилучший путь к пункту назначения с точки зрения оплаты и некоторых других параметров. И эта информация, связанная со всеми платёжными каналами и тем, какие комиссии они взимают, является публичной и общедоступной.

В данном случае, просто чтобы прояснить контекст, если предположить, что это граф Lightning Network, актуальный на данный момент, и, допустим, все каналы взимают равные комиссии, а узел 1 хочет перевести что-то на узел 7, то будет выбран путь, выделенный жёлтым. И точно так же, если вы захотите перевести что-то на узел 13 или 14, будет выбран именно этот путь.

Предположим, существует некий злоумышленник - узел A. Поскольку вся эта информация является публичной, она ему известна. Он знает, что если какая-то транзакция поступает к нему, если какая-то транзакция направляется злоумышленнику A, он может знать, что с большой вероятностью узел 1 является отправителем, поскольку много путей, наилучших для этого конкретного узла путей, проходит через такого злоумышленника.

Мы попытались использовать это в нашем анализе. Как мы это сделали? Мы сделали в два этапа. На первом этапе мы вычислили лучшие пути от всех узлов ко всем узлам, то есть от отправителя ко всем пунктам назначения, которые есть в сети, предполагая, что они выполняют небольшие транзакции. Скажем, один сатоши или один миллисатоши. И как только у нас появляется пара путей от отправителя ко всем другим узлам, проводится анализ.

В чём заключается анализ? По сути, нам нужно вычислить эту вероятность P(A|Bi). В данном случае она может быть рассчитана примерно так. SPiA/SPi, где SPi - это наименьшее количество путей, ведущих к узлу i и проходящих через злоумышленника A. Так что в данном случае, если произвести расчёт, мы получим четыре пути: от первого узла ко второму, от первого к A, от первого к четвёртому и от первого к третьему, верно? Из них три пути пройдут через злоумышленника А. То есть от первого к А, от первого к третьему и от первого к четвёртому. Таким образом, в этом случае вероятность P(A|Bi)  составит 3/4 для данного первого узла. Это просто небольшой пример. То же самое мы проделываем и для всех остальных доброкачественных узлов и всех узлов злоумышленника, присутствующих в сети.

И не только это. Мы наблюдаем и другие важные факторы, влияющие на снижение уровня анонимности. Как мы это делаем? Здесь я привёл пример. Поскольку отправитель и пункт назначения, а также полный путь фиксированы, имеется гораздо больше информации для утечки. Каким образом? Посмотрим.

В данном случае, допустим, противник A получает от четвёртого узла транзакцию, которая должна быть передана восьмому узлу, поскольку путь фиксирован. В этом случае единственными возможными отправителями могут быть только узлы 2 и 4. В идеале можно было бы подумать, что транзакция могла пройти также через узлы 1, 3 и, возможно, 5. Но это не так, поскольку наилучший путь, предполагающий в данном случае равнозначность, лежит только через узлы 2 и 4. Только через второй и четвёртый и до восьмого. Для первого узла, если ему нужно передать что-то восьмому узлу, он сделает это напрямую через узлы 3, 5 и в конце 8. Верно? Таким образом, мы включили эти небольшие дополнения, а затем провели оценку.

Мы вновь произвели моделирование. Мы взяли снимок публично доступной топологии Lighting Network, а затем, основываясь на различных стратегиях, назначили вредоносные узлы, рассчитали распределения вероятностей, энтропию и так далее. В данном случае у нас были различные способы выбора злоумышленника. Я расскажу только о двух из них. Стратегический выбор. Поскольку это сеть платёжных каналов, некоторые узлы используют сразу множество таких каналов. И мы хотели увидеть, какой ущерб они могут нанести, или каков будет объём деанонимизации, если эти узлы будут вредоносными.

Итак, как здесь показано, в топологии Lightning Network по состоянию на 2018 год в качестве вредоносных нами были выбраны узлы с наивысшей степенью сложности. И вот полученные нами результаты. В данном случае на оси x видно, что если 1% узлов высшей степени сложности являются вредоносными, то 25% транзакций могут быть полностью деанонимизированы ими. А для 50% транзакций энтропия равна 2, то есть сомнения возникают только в случае с четырьмя или меньшим количеством узлов. И, как видно, при 10% это соотношение резко уменьшается.

А теперь посмотрим, что произошло в период с 2018 по 2021 год. Вот результаты, которые мы увидели. В каждом случае в качестве вредоносных мы выбирали только узлы, входящие 1% лучших. И на снимке 2021 года, который мы проверяли последним, видно, что для 50% транзакций этот 1% узлов способен полностью деанонимизировать их. И даже для 75% транзакций анонимность составляет всего 4. Сомнения возникают только в случае с 4 отправителями или меньше. При этом размер данной сети составляет около 9000 узлов. Так что среди 9000 узлов можно быть полностью уверенным в 50%. А в 75 %, то есть в четверти, от 50% до 75 %, сомнения вызывают только 4 отправителя.

Вот и всё, что касается анализа. И теперь подведем итог моего выступления. У нас не было способа как-то измерить и сравнить различные схемы обеспечения анонимности маршрутизации, используемые на сетевом уровне и описанные в соответствующей литературе. Поэтому мы сами разработали схему с использованием байесовских вероятностей. Мы применили эту схему к двум существующим схемам маршрутизации, пошаговой и исходной маршрутизации, взяв для этого протоколы Dandelion и Lightning. Мы провели анализ и обнаружили, что большинство этих схем не обеспечивают высокого уровня анонимности транзакций или пользователей. И если вы захотите самостоятельно произвести такой анализ, весь необходимый код и все связанные с ним данные можно найти в открытом доступе на этом сайте.

На этом всё. Спасибо за внимание.
