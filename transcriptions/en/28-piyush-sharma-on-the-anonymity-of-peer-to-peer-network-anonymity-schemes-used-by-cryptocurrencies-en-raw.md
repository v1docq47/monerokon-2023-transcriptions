# Piyush Sharma

_**On the Anonymity of Peer-To-Peer Network Anonymity Schemes Used by Cryptocurrencies**_

[https://youtu.be/kfyhb-GCPEE](https://youtu.be/kfyhb-GCPEE)

---

_**Piyush:**_ This talk is going to be about anonymity of the peer-to-peer network that underlies all cryptocurrency systems.

As you mentioned, my name is Piyush Kumar Sharma, and this work was done in collaboration with Devashish and Claudia at KU Leuven, Max Planck, and NYM. Also, this work was presented at NDSS, which is an academy conference, and this is kind of a version which

So without further ado, I'll just quickly go into the background required to study the problem. So when we talk about cryptocurrency systems, we can think of them very broadly in working, functioning in two layers. One is the application layer, which basically deals with generating transactions, you know, mining blocks, validating and all those stuff.

But then there is an underlying network layer on which all this information is spread to the network, to the peers. So this is basically a peer-to-peer network where every node is connected, and whatever transaction, whatever block you generate, that is broadcasted in the network.

Now, when we talk about anonymity, we want it at both layers. We have so many application layer techniques, but we also want the anonymity at the network layer, because if you only have the anonymity at the application layer, but not in the network layer, then it in itself is not complete anonymity.

And when I talk about network level anonymity, it basically means that we want to map the network identity of the user to the transactions that are seen in the network. So the network identity can be IP addresses.

With this background, we can briefly look at one of the most popular cryptocurrency systems, Bitcoin. And in its peer-to-peer network, by default, if there is a transaction, the default mechanism is to flood that transaction to all the neighbors. This was like pre 2015, and then they do it to their neighbors and so on.

Subsequently, they updated their method, and then instead of immediately transferring the transaction to all the nodes, they transfer it to one node at a time, but with some delay. But both these approaches have been shown to be subject to deanonymization attacks. One was earlier and the other was later. And hence, as a result of that, There are newer approaches that have been proposed recently in the literature to enhance the anonymity of network level in cryptocurrency systems.

Particularly, they can be divided into hop-by-hop routing or source routing schemes. Just to give you the difference, hop-by-hop routing schemes are those in which the decision to route the transaction or the packet is taken at that hop itself. It will randomly decide among which neighbors it wants to transfer to. And in source routing, the complete part of the transaction is fixed. So the sender decides which intermediary hops will be followed till the destination.

And in both these categories of schemes, there are systems. One is Dandelion and Dandelion++ is just part of hop-by-hop routing. This is a system which is also used by Monero to provide network level anonymity, and that is why this talk is interesting to the community. But then I'll also be talking about source routing schemes, which are a very different kind of routing, but still we'll analyze the anonymity.

So till this point, we know that there are these schemes, that there is different kind of routing schemes which have all their different routing properties and anonymity properties. But the fundamental problem was - we do not know how to make sense of what anonymity they provide, because they are different and we do not know how to compare them on common ground.

So one of the main component of the research was to bring all of them to common ground and see how we can analyze the anonymity of any given peer-to-peer system. And in this case, the adversary model is that there are some nodes which are part of the network who are malicious, and the transactions that they're receiving, they want to somehow know who are the originator of these transactions at the network level.

So this is what we want to achieve. How do we want to achieve it? At a high level, we want to build a framework. And what will be given as input to this framework is the network structure. How is the connectivity in the network? What is the routing scheme to send messages or transactions in the network? And what are the observations you're getting from the network - transactions, blocks, and so on?

Once we give all these inputs to the framework, it wants to output what is the anonymity set, or how many users or how many senders can I deanonymize in the network, or if I cannot deanonymize, how much doubt I have for every particular transaction. And how can we achieve this is with the help of something known as Bayesian probabilities. I'll now then move on to how we basically build this framework with this idea in mind.

So for defining this framework, I need to define some events. These are very simple events. One event is Bi, which is basically some benign node or some normal node in the agent rates of transaction. Then there is another event that is the red node, which is the adversary node. It receives a transaction, right? Given these two events, what are we interested to know from an anonymity perspective?

It is that this probability, which is conditional probability, P(Bi|A). Now what that means is, given that some adversary node has received a transaction, in this case the red node, what is the probability that some node I generated it in the network? If you can have this for all the possible originators in the network, we can start to make sense of who is the more probable sender, who is the less probable sender, and we can then use this information to basically calculate anonymity sets.

But how do we compute this probability, P(Bi|A)? For that, in Bayesian's theorem, there is this formula. This probability can be calculated by calculating these terms, what these terms essentially mean in this context. P(Bi) is the probability that some benign node i generates a transaction. P(A) is the probability that an adversary node receives any transaction. And P(A|Bi) is the probability, given that some benign node i generated a transaction, what is the probability that transaction will reach an adversary node? So this is slightly different than the earlier one. And if we can have the values of all of this, we can calculate A for all i's, and then we can make sense of it. So how do we do that?

Let's assume there are N nodes, there are C corrupted nodes in the network. And then this P(Bi), which is the probability of a node generating a transaction, we assume it to be equal. That is, every node in the network is equally likely to generate a transaction.

Now, from an adversarial perspective, this is a very bad case because we do not know if someone is more probable to generate a transaction or less. But still we'll see that with the analysis, even with this assumption the anonymity is not very good.

So this is how we can calculate the probability of a node generating a transaction. The probability that any transaction will reach an adversary can be calculated by multiplying the probability of a node generating a transaction with the probability that the transaction reaches the adversary. And if you do this for all the nodes in the network, this is how it can be achieved. And without going into further details, if we substitute these in the formulas, what we'll get is eventually what is there on your extreme right corner, in which case the only thing that we need to calculate is P(A|Bi). This is some probability, and we'll look at how we can do this. And once we have this, we'll have a probability distribution of who are the possible senders for any given transaction.

So far, so good. But what do we do with this information? These probability distributions do not tell us anything about who is the probable originator or how many possible originators are there for these transactions.

For this, for calculating the anonymity, we use something which is known as entropy, which is given by this formula. But essentially, what it means is - it is measured in bits - if you have an entropy of two bits, it means you have doubt among two to the power two possible centers, which means if the entropy is zero bits, that means you can clearly deanonymize or you can know who the potential sender is, right, because it will be 2 to the power 0.

Okay, so we can have probability distributions, we can then calculate the anonymity or anonymity sets in this case. Now how do we use this framework to model the existing schemes that are there, both hop-by-hop routing and the source routing.

So we'll start off with the hop-by-hop routing scheme. We'll start with the Dandelion. How does it work? It essentially works by having two sets of graphs. What is the first graph? First is the existing Bitcoin peer-to-peer graph, which is there in the network. And secondly, it creates its own privacy subgraph, which is a subgraph of the actual Bitcoin graph. Why is it a subgraph? Because it covers all the nodes in the network, but it is supposed to be a line graph. We'll look at why this is important and how this provides anonymity, but this is how Dandelion functions with the help of these two graphs.

Once they define these graphs, what they have is something known as a two-phased operation, stem phase and the fluff phase. And we'll just look at how this phases work.

So let's see, let's suppose this is an example of a network where initially every transaction will be in the stem phase. That is, it will be forwarded on the privacy subgraph. So let's say Bi has a transaction which it wants to broadcast in the network. Instead of being instantly being broadcasted in the network, it will be forwarded to some intermediary nodes in the network to a particular point. And after that, at each node, there will be a decision that will be made. Should we continue forwarding it in a single line, or now should we broadcast it to the network? And at some point of time, in this case, when it reaches node Bj, the transaction will be broadcasted to the network, which is on the right side. We already saw in the background or in the related work section that this diffusion process, that is the part from where this node Bj broadcasts the transaction in the network, in that case, you can still identify the source of the originator. So in this case, if you do the analysis, you will still know that the originator is the node Bj, right? But the original originator was Bi. So in this way, Dandelion provides anonymity to the transactions. And it only provides it essentially in the stem phase. Thus, it makes sense to only look at this stem phase and how we can put it into our framework.

And how do we do that? So we abstracted out this line graph, which was there in the render line, which is the previous subgraph. And here again, let's see that there is some adversary node. It receives a transaction. And now it starts doing calculations. What calculations it will do? Let's see the node which is just behind it. What is the probability that the transaction of this node will reach the adversary?

So it's one. All the transactions that are generated by just the previous hop will reach the next hop because that is a defined parameter in the system. At least you have to transfer a transaction to one hop. So first, nodes, all transaction will be received by adversary A, okay?

What about node two? So for this, the transactions can be calculated by one. That is, it will transfer all its transactions to its immediate node. But then from that point onwards it will decide whether to forward it to node A or to diffuse in the network based on the probability known as pf, which is the forwarding probability. So in this case, it will be 1*pf that the transaction reaches adversary node A.

And similarly, if we look at three, it will be 1*pf*pf. And if you have to generalize for any given benign node in the network, how we can do that is we need to multiply (pf)hi-1 number of times where hi is basically the number of hops between this benign node i and the adversary.

So with this way, we will be able to model Dandelion system. And obviously, there were other - so this is the default way of analyzing it, but there were other ways with which you can reduce the set, which consists of the nodes. So in this case, if you take an example, let's say there are two adversaries. If an adversary, A2, receives a transaction, then it can be sure that the originator is only among the node 1 or N. It cannot be an originator between N+1 to M, because they are colluding. If the transaction would have been generated by nodes N+1 to M, then it would have been received by A1 first. And if A1 already received it, it would already have communicated that I have received this transaction. You do not have to do the analysis. So these kind of small changes we incorporated in the analysis. And this is how we modeled Dandelion.

And there was a successor system for this, Dandelion++, in which everything remained the same. But now instead of a line graph, they create a 4-regular graph, which essentially means it will have two outgoing edges and two incoming edges as an improvement.

So if we look at this graph, how will the privacy subgraph in this case look like? It will look like something like this, where every node has two outgoing edges, right? And for the purpose of analysis, let's say there is an adversary node A again, and now we want to calculate it received a transaction. What is the probability that it received from node 1?

So for that, we'll have to calculate all the parts that leads from 1 to A, because that is the only way the transaction could have reached A. So in this case, there are two parts. As you can see, 1, 2, 4, A, and 1, 2, 3, 4, A. And for all of them, we need to calculate the probability, like we did earlier. So in this case, node 1 will always forward it to its next hop, but it has two next hops. So it will select equally likely. That means there is 50% chance of selecting the next hop. So it will be 1/2 probability that it will reach node 2.

After that, it will decide based on the forwarding probability: should I forward it or should I diffuse it? If it decides to forward, then we have probability pf. And that will again be divided by 2, because it did not forward to 3, but to 4. And similarly, from 4 to 8 will be pf/2. And we can do this calculation for all the parts. And we can generalize this scheme with the help of this formula where we can calculate in the case of Dandelion++ by multiplying half into (pf/2)hi-1 number of times, so hi is again the number of hops. But in this case, we need to do this for all the parts that are possible.

And once we do this, here again we look at, can this somehow be better by multiple adversaries colluding? If you look at this example, you can see that if A3 receives a transaction, then it can be sure that the possible originators are only among 5 to 10. It cannot be among 1 to 4 because if 1 to 4 would have generated the transaction, it would have been captured by A1 and A2 first. Right? And even more so, if we'll closely look at node 10, if A3 receives a transaction from node 10, then it can be 100% sure that 10 is the originator. Because, 10 to 1 outgoing hop is to adversary node and other outgoing hop is also to adversary node. And if they know this graph, then they can very easily see that there's only one possible way - I did not generate it. If you are receiving it, then it is the originator.

So, this is how we perform the analysis of Dandelion and Dandelion++. But this is all the analysis part. What were the results? So for that, we constructed peer-to-peer graphs, line graphs, and 4-regular graphs, because for Bitcoin we did not have an implementation. And then we assumed random adversary nodes in the network, some fraction of it. And then we vary various parameters, such as what is the effect of forwarding probability, what is the effect of the total number of corrupted nodes in the network, total nodes in the network, and so on.

And this is one of the results that we observed. So in this case, we keep two parameters constant, that is the forwarding probability, we keep it as 0.9. That means that every hop, there is a 90% chance that it will continue in the stem phase and 10% chance that it will diffuse in the network. We also assume that there is 1% of the adversarial nodes in the network of the total nodes. In this case, what do you observe that even when you kept increasing the network size. On the x-axis, on the y-axis, you can see that the entropy is not increasing. And what that essentially means is even if you'll keep increasing the size of the network, you'll not be able to increase your anonymity, which would have been the case, right? If you're having more users joining the network, then you should have more doubt on more users. But this is not what we observed from our analysis.

And then, when we varied the number of corrupted nodes in the network from 5% to 50%, this is what we observe, that for Dandelion, let's say if there is 25% collusion, that is one-fourth of the network wants to somehow do some deanonymization, you can see that for 10% of the transactions, they can completely identify who the originator is. But the median line, which is the red line, which somewhat comes close to two, for 50% of the transactions, they only have doubt among four possible originators. So out of 1,000, for 50% of the transactions, you only have doubt among four.

Then similarly we have for Dandelion++, in that case, obviously the overall anonymity increased. But if you have a sufficient number of adversaries in the network, even in this case, for 10 to 5%, the 10% of transactions can be completely denonymized.

So this is what I had for hop-by-hop routing, which is a routing scheme. And then we could look at a system for source routing. In this case, we have Lightning Network. So what is Lightning Network? It is basically a payment channel network, which was built to provide scalability, as well as privacy to the Bitcoin transactions. It uses onion routing. That is, the source decides what the actual path will be, and no node in the intermediary nodes more than its previous hop and the next hop in the network.

And obviously, since transactions are forwarded through these different payment channels, they charge fees. And because they charge fees, the client selects the best path based on fees and also the parameters to decide when it is sending to a particular destination. And this information of the whole payment channel and what fees they charge, this is public and known to everyone.

So in this case, just to give you some context, if you assume this is the Lightning Network graph, which is currently there, and let's say all of them have equal fees, and node 1 wants to transfer something to node 7, the path that will be selected will be the one highlighted in yellow. And similarly, if you want to transfer to node 13 or 14, this will be the path.

In this case, let's assume there is some adversary node A. Since this information is public, it knows all the information. It knows that if some transaction is coming to it, if some transaction is routed by adversary A, it can know that there is a good chance that node 1 is the forwarder because a lot of paths, best paths, goes via this adversary for this particular node.

So we try to leverage this in our analysis. And how we did that? We had two steps. In the first step, we calculated the all to all, that is all source to all destination, best paths that are there in the network, assuming that they perform the lowest amount of transaction. Let's say one Satoshi or one Millisatoshi. And once we have this all to all source pair paths, we do some analysis.

And what is that analysis? Essentially, we needed to compute this probability P(A|Bi). In this case, it can be calculated by something like this. SPiA/ SPi, which SPi is the shortest number of paths, paths which are for node i, and they go via adversary A. So in this case, if I do a calculation, one has four paths, 1 to 2, 1 to A, 1 to 4, and 1 to 3, right? Out of that, three of those paths will go via adversary A. That is 1 to A, 1 to 3, and 1 to 4. So in this case, the probability P(A|Bi) will be 3/4 for this particular node 1. And like this, we do, for this small example, like this we do for all other nodes and all other adversary nodes in the network.

And not only this, we do other important reductions in the anonymity set. How we do that? Here I have taken an example. Because the source and the destination and the complete path is fixed, so there is more information to leak here. How? We'll just see.

In this case, let's say adversary A receives a transaction from node number 4, and it had to be transferred to node number 8, because the path is fixed. In this case, the only possible originators can be 2 and 4. Ideally, you would think that, okay, node 1, 3, and maybe 5 also transaction could have gone via, but it is not the case, because the best path, assuming equal weights in this case, is only via 2 and 4. It's only for 2 and 4 via 8. For node 1, if they have to go to the node 8, they will directly go via 3, 5, and 8. Right? So this is how we incorporate these small additions and then eventually performed an evaluation.

So here again, we actually developed a simulator. We obtained the public topology snapshot of Lighting Network that is there. And then we assigned adversity nodes based on different strategies, calculated probability distributions, the entropy, the same thing. We had various ways of selecting the adversary in this case. I'll only talk about two of the ways. The strategic selection, because it is a payment channel network, some nodes have a lot of payment channels. And we wanted to see how much damage or how much deanonymization can they do if they are the adversaries.

So if you look at that, we selected the top degree nodes as the adversary in the Lightning Network for a topology which was there in 2018. And these are the results that we observed. So in this case, you can see on x-axis that if 1% of the top degree nodes are the adversary, then 25% of the transactions can be completely deanonymized for them. And 50% of the transactions, the entropy is 2, that means you have doubt only among four or less number of nodes. And you can see if there is 10%, this ratio decreases drastically.

And if we now move ahead and look at what happened in a while from 2018 to 2021. So these are the results that we saw. In each case, we only selected top-1% nodes degree as the adversary. And the 2021 snapshot for the one which we last checked latest, you can see that for the 50% of the transaction, these 1% nodes can completely deanonymize them. And even for 75% of the transactions, the anonymity is just 4. The doubt is only among 4 people or less. And just to tell you, the size of this network is around 9,000 nodes. So among 9,000 nodes, for 50% you are completely sure. And for 75%, like 50% to 75% quartile, you're only having doubt among 4 people.

And so this was all about the analysis. Now, to summarize what you can take away from this talk. So essentially there was no way for us to measure somehow and compare the different routing anonymity schemes that are network level routing anonymity schemes that are there in the literature. So for that, we developed a framework using Bayesian probabilities. We applied that framework to two existing routing schemes, hop-by-hop andsource routing, for that we have Dandelion and Lightning. And we performed an analysis and observed that most of these schemes do not provide very high anonymity to the transactions or to the users. And if you want to play around with this analysis or this, so all the code and all the related data is public on this website.

So yeah. Thank you so much.
