# Juraj Bednar

_**Analysing Monero Merchants' Traffic Using Simple Chainanalysis**_

[https://youtu.be/-sTT84Up7FY](https://youtu.be/-sTT84Up7FY)

---

_**Juraj:**_ Okay, so welcome, good morning. I'm happy that you came here and let's do some kind of accounting. So I've counted that there are 10 seats in each, or actually 20 seats in each row, then there are 10 rows. So this room hosts about 200 people. I would say it's 50% occupied. So not all seats are used. And if you all paid on average 100 euros to get to this event, then this would be a revenue of 10,000 euros to organize this event. Of course, we have to count the sponsors, but we can easily think about the business case that this conference has. How much does it cost to organize a conference like this? What are the costs? And so on. And I do this all the time. It's kind of like an OCD thing for me. I go to an airplane, I count the seats, I say: "Okay, what's the average price of the ticket? Oh, okay, so one ride of an airplane costs this much".

I was thinking if people are doing this to me because I'm a merchant, I accept cryptocurrencies. And I'm very cautious about things. So for example, if I accept on-chain Bitcoin, what I would do is I would spend each UTXO, each payment separately, so my customers don't meet in a transaction. So one customer doesn't check, what is the balance of the other customer and so on. So I've been doing this for many years, but with Monero it was like - oh yeah, it's private. I don't have to deal with this. It's like privacy is what Monero is about.

And a few months ago I was buying something from a merchant that accepted Monero. So of course I chose Monero to pay for the service. And the merchant accepted Bitcoin, Litecoin, Ethereum and Monero. So with Bitcoin, Litecoin and Ethereum, I just looked at the blockchain and I saw - okay, so I did this calculation, you know, how many people paid how much and okay, I see if this a successful business? It was very interesting for me because they were doing something similar to me, at least in the genre, not in the content. But I was like: "Okay, but what if half of the customers paid in Monero? Then I wouldn't know the exact number".

So I started thinking: "Okay, I need to figure this out". So this is a very simple thing. It's not anything revolutionary. It has been known for a long time. But let's see how you can actually do it in practice and estimate the turnover of the merchant.

So I have some assumptions. So a merchant accepts Monero for purchases. My assumption is they end up in the same wallet, which in the case of this merchant is they were using a static address and ask the customer to provide a hash of the transaction, the transaction ID which is a little bit more secure than in Bitcoin because of stealth addresses. So in Bitcoin you would just see the merchant got paid to this address and you can see the TX ID from the block explorer. Or you use something like BTCPayServer with Monero plugin and that generates subaddresses but they all end up in the same wallet. So it works with both cases.

I want to estimate the turnover, so the revenue of the merchant. Of course, we don't see amounts, but if they use other cryptocurrencies, it is quite easy to estimate. Okay, I look at Bitcoin, Ethereum, Litecoin transaction. I estimate the average order size. Again, it could be different for people who pay with Monero. Maybe they have some different customer behavior. But in general, it is quite a safe assumption. In this case, it was much easier, because it was only one product for the same price for everyone. So every order is exactly the same price. For example, if it's a paid newsletter subscription, access to an online course or an e-book, you can see that this person earns this much per order.

Monero wallets usually don't either allow coin control or if they allow, most people don't use coin control. How many of you use coin control with Monero transactions? Perfect, we have two heroes. So with Bitcoin we kind of assume we need to do it and we do it all the time. I was saying I'm spending it per coin, I make sure the customers don't meet in a single transaction, I swap it out to some other network, in my case usually Lightning. But Monero merchants usually it ends up in the same wallet and they sweep from time to time. That's what allows the attack.

Usually, what merchants would do is they would take the funds and either send the balance to some other wallet. For example, if you have a payment gateway, either yours or third party, so if it's yours, it might be a BTCPayServer. You would want to take the money out of there, maybe to a hardware wallet, maybe it is a hardware wallet, but maybe you want to send it somewhere else. One of the reasons is because of subaddresses, you need quite a high look ahead, because there may be many people who go to the checkout page, but they don't pay. So you can't really receive if you are generating subaddresses, into a normal wallet that you use daily, because you need to scan for more cell addresses. Many people do this. Of course, they can also spend the coins. That will tell you something. Maybe it will not tell you such good numbers, but you also will see a minimum. You could safely assume that the turnover is this amount or more.

The sweep transaction will be usually more inputs, so that's what stands out on the chain. But it doesn't have to be, but it can be. Let's see. What we can do is we can send multiple payments to the merchant. For example, we split the one payment into two outputs. It arrives in a single transaction. Actually the merchant even sees that it is one transaction. They will see in their wallet that they received the amount that they were expecting. So it's nothing suspicious, only if you look at the transaction. But the wallet usually tells you, it received $100 or one Monero or something like this.

Another thing is you can spray the address or subaddresses if you can create multiple orders. And you can send some small amounts of XMR to a single address. Or create one or more fake orders and do it like this. Now the assumption is that the merchant is going to spend this money in one transaction. So they will use both of these outputs in the rings in some transaction. Of course this gives us basically an assumption over a certain period of time. Maybe between the first transaction and the last one. But we can continue doing this if we see - okay the merchant swept all the coins, we can do the attack again. And then estimate per time, let's say per week, or depending on how often they sweep the funds, what is the turnover.

So let's see how to do this. So this is a real-world use case. I'm de-anonymizing my transaction, but I churned the coins later quite nicely. So I'm not worried about disclosing this to you. So there was one transaction, there's one output, second transaction, second output both outputs are number zero, so the first output of the transaction. So this is what I sent to the merchant.

So how do I actually get the sweeping transaction from the blockchain? Unfortunately, no block explorer that I found. Maybe you can help me and it would make it much easier. There is no open source Monero blockchain explorer or open access Monero blockchain explorer that can search using the outputs. We need to write a little bit of code. This is just a gist on my GitHub so you can do it yourself. It's very simple. So don't worry, just change some parameters.

First of all, we know the block height of our transaction. We don't have to search the whole blockchain. We know when to start. It has to be 10 blocks after the second transaction happened. That's when the coins could actually be spent. Another thing is that in Monero you don't identify the output by this hexastring, but you identify it by indices. So, indices are just numbered outputs in the chain. So, first you need to convert the hexastring into index. So there's a little code for that. By the way, I never used any Monero API. I wanted ChatGPT to write the code for me and I wasted one hour of my life because it was hallucinating APIs that would be very useful, but they don't exist. So then you can see if it's the right transaction. You can compare the key, the stealth public key and the index.

Then one more thing, the output indices are relative. So you need to add the numbers. They're ordered by index or time. So you need to convert these relative indices in the transaction to absolute ones. And then basically I wrote this short code that will go through the chain and see where there is a transaction that contains the ring members. So these are the indices, I actually use this one. Yes. So these are the indices, this is the mean height and then I just very slowly go through whatever one week of transactions, and I want to find one transaction that has both of these outputs as a member of the rings used this input. So I ran it.

So it doesn't only display the transactions that have both of them. So basically, this transaction I see has both of them. These other ones are useless. But this one is a good candidate. So we can check it out. We can see when it was mined. This is very important for the estimation of time, because we want revenue over time. We want to know if it's like for three days or for a week or for a month, something like that. We verify that the outputs are actually used in the rings. Of course, it could be a coincidence to reduce the chance of coincidence you can do more than two. You can do five and then it's definitely not a coincidence. So this is very likely that this is the sweeping transaction of the merchant.

So what does it say? It has four inputs. I know that two of them are mine, but I'm a customer, so I count myself as well. I know when it was mined what's the time of our oldest output and we get a rough estimate of three orders and it looks like a sweep for a day. So it's one day, the merchant actually confirmed my order two hours after sweeping the transaction. So it's a good estimate that this merchant has in this case around three orders per day. Of course, I can repeat this because there are better and worse days. If it's nice weather somewhere, maybe people don't buy stuff for Monero and go outside.

So now we do the same assumption as I did in the beginning. The product costs, let's say, 100. So the turnover for the merchant is around 300 for the day. I also include Bitcoin, Ethereum and Litecoin, which I just seen in the Block Explorer. I don't have to do anything and we can repeat this.

So, it needs an active attack. So, in contrast to public blockchain, you need to actively do something. And it's not just a matter of looking on chain. You need to be an active attacker which is quite good because you cannot go to a chain analysis company and tell them: "Oh you know I need to know what happened one year ago". But on the other hand I realized even on my experience that Monero is not this magic, nothing is seen on chain technology that you can just whatever you say: "Oh, it's Monero I don't have to care about it". Because if this information is something that you don't want to make public, maybe to the state, more likely to competition, then it might be a problem.

So how do other coins compare and what you can do? And then I'll say what you can do with Monero.

So with blockchain-based non-private coins, you need coin control. BTCPayServer, which is a good merchant solution, allows this directly from BTC and LTC. You just use the interface of BTCPayServer and you can select coins and you can spend them in random times and per UTXO maybe do a Lightning swap or swap to Monero or to some mixing or privacy service.

Lightning is actually great by default. It also needs an active attack, so you cannot learn about the transactions from the past. Some network-wide attackers could still correlate recipient keys, especially if they run, of course, custodial wallets. Wallets that outsource routing. So for example, the difference between Phoenix and Breez is Breez is doing the routing on the own. It creates the route, talks directly to the nodes and when the route is created, it pays the payment. So, Breez, as an operator, sees that there is a transaction going through, but they don't see who's the recipient. With Phoenix, it just says: "Oh, I want to pay this invoice, please find me a route", and then it just clears. So in this case, what you can do, there is a project called Allen Proxy, which creates just a random node key that you pay to. And this invoice will be paid only when the original invoice is cleared. So no one actually sees this.

What can you do in Monero? Of course, coin control is good. If the attacker just sprays the address with small amounts, you can just take the small amounts and send them to Monero Development Fund or Tor Foundation or whoever you want. If you see two outputs that are from the same transaction, you can sweep both of them. Because you know that they probably belong, they were sent by the same person. And then what is good is when you are doing the sweep, do it per two outputs. Because the problem here was that why these transactions stood out is because it had four inputs. So if you take two and two all the time, then it will break, because it will be included in this output, and there are many transactions just by chance include the output. So that would not tell the attacker anything useful. So if you cannot use coin control, but Feather Wallet does it and it works quite nicely. But if you cannot do, then the best other thing is sweep often. So when you receive a new order, new order payment, just send it out and don't wait until other orders come in. So then of course you can just do the send to self the churning of the coins a little bit more and that will help.

Of course in the future I very much hope for full membership proofs that could be even better more useful in mitigating this kind of attack. Thank you very much.